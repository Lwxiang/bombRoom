<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>BOMB ROOM</title>
{% load staticfiles %}
<script src="{% static 'js/jquery.min.js' %}"></script>
<link href="{% static 'css/index.css' %}" rel="stylesheet" type="text/css">
</head>
<!--
(c) 2015 ccloli. 2015 年自强 Hack Day 作品 BOMB ROOM 前端页面
-->
<body>
<div class="page access-page" data-action>
	<div class="logo">BOMB ROOM</div>
	<div class="access">
		<form action="http://121.43.228.141:8000/allot/" method="post" class="form form-access">
			<input type="text" class="input" name="name" placeholder="您的昵称" required="required">
			<!--<input type="email" class="input" name="email" placeholder="您的邮箱（使用 Gravatar）" required="required">-->
			<button class="button button-enter">进入</button>
		</form>
	</div>
	<div class="front">
		<form action="http://121.43.228.141:8000/host/" method="post" class="form form-create">
			<!--<input type="text" class="input" name="" placeholder="房间名称">-->
			<input type="text" class="input" name="capacity" placeholder="参与人数" required="required">
			<input type="text" class="input" name="length" placeholder="房间宽高" required="required">
			<input type="text" class="input" name="energy" placeholder="每回合执行代码数" required="required">
			<button class="hidden"></button>
			<!--<input type="text" class="input" name="name" placeholder="您的昵称">-->
		</form>
		<form action="http://121.43.228.141:8000/enter/" method="post" class="form form-enter">
			<input type="text" class="input" name="host" placeholder="房间 ID" required="required">
			<button class="hidden"></button>
			<!--<input type="text" class="input" name="name" placeholder="您的昵称">
			<input type="text" class="input" name="email" placeholder="您的邮箱（使用 Gravatar）">-->
		</form>
		<div class="message"></div>
		<div class="entry">
			<button class="button button-create" data-type="create">创建房间</button>
			<button class="button button-enter" data-type="enter">进入房间</button>
			<button class="button button-return" data-type="return">返回</button>
		</div>
	</div>
	<div class="room">
		<div class="map">
			<table border="1">
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</table>
		</div>
		<div class="number">NO. </div>
		<button class="button button-start">开始游戏</button>
		<button class="button button-leave">离开房间</button>
		<div class="codebox">
			<div class="codebox-output">
				<div class="codebox-output-content">
					<div class="codebox-output-line">欢迎来到 BOMB ROOM！</div>
					<div class="codebox-output-line">Justin 加入了房间。(5/6)</div>
					<div class="codebox-output-line">Jeff 加入了房间。(6/6)</div>
					<div class="codebox-output-line">游戏顺序为  <span style="color: #0f0;">Jeans</span> <span style="color: #f00;">Ben</span> <span style="color: #00f;">Jeff</span> <span style="color: #ff0;">Sam</span> <span style="color: #0ff;">Justin</span> <span style="color: #f0f;">Sandy</span>，每个回合您可至多执行三条代码。</div>
					<div class="codebox-output-line" style="color: #f00;">这是您的颜色</div>
					<div class="codebox-output-line">游戏开始，首先由 Jeans 操作。</div>
					<div class="codebox-output-line" style="color: #0f0;">Jeans 执行了一次操作。</div>
					<div class="codebox-output-line" style="color: #0f0;">Jeans 执行了一次操作。</div>
					<div class="codebox-output-line">Jeans 完成了操作。现在轮到 您 了。</div>
					<div class="codebox-output-line" style="color: #999;">moveWest()</div>
					<div class="codebox-output-line" style="color: #f00;">您向西侧移动了一步。</div>
					<div class="codebox-output-line" style="color: #999;">putBomb()</div>
					<div class="codebox-output-line" style="color: #f00;">您安置了一个炸弹！请注意安全！</div>
				</div>
			</div>
			<!--<textarea class="codebox-input"></textarea>-->
			<div class="codebox-input" contenteditable="true"></div>
		</div>
	</div>
</div>
<script>
var page = $('.page');
var entry = $('.entry');
var message = $('.message');
var codebox = $('.codebox');
var CodeboxInput = $('.codebox-input');
var CodeboxOutput = $('.codebox-output-content');
var outputLine = $('<div>').addClass('codebox-output-line');
var user = {};
var userList;
var uid;
var mid = 0;
var checkMsgTimer;
var num;
var start = 0;
var energy = 0;
var status = -1;
var mycolor;
var roomData;
var userData;
var colors = [];

function getErrorMsg (status) {
	var msg = ['非法操作', 'success', 'method must be post', 'method must be get', 'uid is invalid', 'no authority to do(Who try to change the room infomation is not the host)', 'the room is full or no exist'];
	return msg[status];
}

function getMapString (length) {
	var mapString = '<table border="1">'
	var trString = '<tr height="' + 100 / length + '%">';
	var tdString = '<td width="' + 100 / length + '%"></td>'
	for (var i = 0; i < length; i++){
		trString += tdString;
	}
	for (var i = 0; i < length; i++){
		mapString += trString + '</tr>';
	}
	mapString += '</table>';
	return mapString;
}

function checkForm ($form) {
	var inputs = $form.children('input');
	return [].every.call(inputs, function(elem){
		//console.log(elem.hasAttribute('required'), elem.value, elem.value.trim() !== '')
		return elem.hasAttribute('required') ? elem.value.trim() !== '' : 1;
	});
}

function fetchForm ($form) {
	var inputs = $form.children('input');
	var data = {};
	[].forEach.call(inputs, function(elem){
		data[elem.getAttribute('name')] = elem.value.trim();
	});
	return data;
}

function showRoom (id) {
	$('.number').text('No. ' + id);
	if (id == user.uid) $('.button-start').show();
	else $('.button-start').hide();
	CodeboxOutput.empty();
	$.ajax({
		method: 'POST',
		url: 'http://121.43.228.141:8000/room/',
		xhrFields: {
			withCredentials: true
		},
		data: {
			host: id
		},
		success: function(data) {
			if (data.status != 1) return outputLine.clone().text('进入房间失败：' + getErrorMsg(data.status)).appendTo(CodeboxOutput);
			uid = id;
			$('.map').html(getMapString(data.info.length));
			outputLine.clone().text('欢迎来到 BOMB ROOM！').appendTo(CodeboxOutput);
			outputLine.clone().html('可用指令：turnLeft() 向左转<br>　　　　　turnRight() 向右转<br>　　　　　goForward() 向前走<br>　　　　　putBomb() 放下炸弹<br>　　　　　endTurn() 提前结束此回合').appendTo(CodeboxOutput);
			outputLine.clone().text('BOMB ROOM #' + id + '　房主：' + data.info.name + '　指令上限：' + data.info.energy + '　用户上限：' + data.info.capacity /*+ '　用户列表：' + data.info.players.join(', ') */+ ' (' + data.info.num + '/' + data.info.capacity +')').appendTo(CodeboxOutput);
			getLatestMsg();
		},
		dataType: 'json'
	});
}

function getLatestMsg () {
	clearTimeout(checkMsgTimer);
	$.ajax({
		method: 'POST',
		url: 'http://121.43.228.141:8000/query/',
		xhrFields: {
			withCredentials: true
		},
		data: {
			mid: mid
		},
		success: function(data) {
			if (data.status != 1) return outputLine.clone().text('获取消息失败：' + getErrorMsg(data.status)).appendTo(CodeboxOutput);
			data.info.data.sort(function(a, b){
				return a.mid - b.mid;
			})
			for (var i = 0, j = data.info.data; i < j.length; i++) {
				outputLine.clone().text(j[i].content).appendTo(CodeboxOutput);
				if (j[i].mid > mid) mid = j[i].mid;
			}
			//for (var )
			// outputLine.clone().text().appendTo(CodeboxOutput);
			checkMsgTimer = setTimeout(getLatestMsg, 5000);
			$('.codebox-output').scrollTop(CodeboxOutput.height());
			userData = data.info;
			start && colorMap(data.info.order_id, data.info.position);
		},
		dataType: 'json'
	});
	if (!start) {
		$.ajax({
			method: 'POST',
			url: 'http://121.43.228.141:8000/room/',
			xhrFields: {
				withCredentials: true
			},
			data: {
				host: uid
			},
			success: function(data) {
				if (data.info.num != num) {
					outputLine.clone().text('BOMB ROOM #' + uid + '　房主：' + data.info.name + '　指令上限：' + data.info.energy + '　用户上限：' + data.info.capacity /*+ '　用户列表：' + data.info.players.join(', ')*/ + ' (' + data.info.num + '/' + data.info.capacity +')').appendTo(CodeboxOutput);
					num = data.info.num;
				}
			},
			dataType: 'json'
		});
		if (uid != user.uid) checkStart();
	}
	else checkTurn();
}

function checkStart () {
	if (uid == user.uid || start) return;
	$.ajax({
		method: 'GET',
		url: 'http://121.43.228.141:8000/wait/',
		xhrFields: {
			withCredentials: true
		},
		data: {
			host: uid
		},
		success: function(data) {
			if (data.status != 1) return;
			outputLine.clone().text('游戏已开始。').appendTo(CodeboxOutput);
			start = 1;
			gameStart();
		},
		dataType: 'json'
	});
}

function checkTurn () {
	if (!start) return;
	$.ajax({
		method: 'GET',
		url: 'http://121.43.228.141:8000/turn/',
		xhrFields: {
			withCredentials: true
		},
		data: {
			host: uid
		},
		success: function(data) {
			if (data.status == status) return;
			if (data.status == 1) outputLine.clone().text('现在轮到您了。').appendTo(CodeboxOutput);
			else if (data.status == 7) {
				outputLine.clone().text('您取得了最终的胜利！').appendTo(CodeboxOutput);
				start = 0;
			}
			status = data.status;
		},
		dataType: 'json'
	});
}

function gameStart() {
	$.ajax({
		method: 'POST',
		url: 'http://121.43.228.141:8000/room/',
		xhrFields: {
			withCredentials: true
		},
		data: {
			host: uid
		},
		success: function(data) {
			if (data.status != 1) return outputLine.clone().text('初始化失败：' + getErrorMsg(data.status)).appendTo(CodeboxOutput);
			roomData = data.info;
			for (var i = 0; i < data.info.num; i++) {
				colors.push('rgb(' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ',' + Math.floor(Math.random() * 256) + ')');
			}
			$('.map').html(getMapString(data.info.length));
			outputLine.clone().html('BOMB ROOM #' + uid + '　房主：' + data.info.name + '　指令上限：' + data.info.energy + '　用户上限：' + data.info.capacity + '　用户列表：' + data.info.players.map(function(elem, index){
				return '<span style="color: ' + colors[index] + '">' + elem + '</span>';
			}).join(', ') + ' (' + data.info.num + '/' + data.info.capacity +')').appendTo(CodeboxOutput);
			data.info.players.filter(function(elem, index){
				mycolor = colors[index];
			})[0]
			outputLine.clone().html('<span style="color: ' + mycolor + '">这是您的颜色</span>').appendTo(CodeboxOutput);
			start = 1;
			getLatestMsg();
		},
		error: function (e) {
			return message.addClass('show').text('HTTP Error ' + e.status + ': ' + e.statusText);
		},
		dataType: 'json'
	});
}

function colorMap (order, position) {
	$('.map').html(getMapString(roomData.length));
	for (var i = 0; i < order.length; i++) {
		$('.map tr').eq(position[i].split(',')[1]).children('td').eq(position[i].split(',')[0]).css('background', colors[i]);
	}
}

entry.on('click', 'button', function (event) {
	var target = $(event.target);
	//console.log(page.data('action') != target.data('type'), page.data('action'), target.data('type'))
	if (page[0].dataset.action != target.data('type')) {
		page.attr('data-action', target.data('type'));
		message.text('').removeClass('show');
	}
	else {
		if (target.data('type') != 'return') {
			var form = $('.form-' + target.data('type'));
			form.find('button').click();
			/*
			message.addClass('show');
			if ([].some.call(form.children('input'), function(elem){
				return !elem.value.trim();
			})) return ((message.text('请完整填写表单')) && setTimeout(function(){
				message.text('').removeClass('show');
			}, 2000));
			var formData = new FormData(form[0]);
			message.text('正在提交数据......');
			entry.addClass('hide');
			$.post('http://121.43.228.141/host/', form, function(data){
				console.log(data);
			}, 'json')
			*/
		}
	}
});

$('.form-access').on('submit', function (event) {
	event.preventDefault();
	var form = $('.form-access');
	message.addClass('show').text('正在提交数据......');
	if (!checkForm(form)) return ((message.text('请完整填写表单')) && setTimeout(function(){
		message.text('').removeClass('show');
	}, 2000));
	var formData = fetchForm(form);
	$.ajax({
		method: 'POST',
		url: form.attr('action'),
		xhrFields: {
			withCredentials: true
		},
		data: formData,
		success: function(data) {
			if (data.status != 1) return message.addClass('show').text('提交失败：' + getErrorMsg(data.status));
			user = data.info;
			message.removeClass('show').text('');
			page.removeClass('access-page').addClass('front-page');
		},
		error: function (e) {
			return message.addClass('show').text('HTTP Error ' + e.status + ': ' + e.statusText);
		},
		dataType: 'json'
	});
	return false;
});

$('.form-create').on('submit', function (event) {
	event.preventDefault();
	var form = $('.form-create');
	message.addClass('show').text('正在提交数据......');
	if (!checkForm(form)) return ((message.text('请完整填写表单')) && setTimeout(function(){
		message.text('').removeClass('show');
	}, 2000));
	var formData = fetchForm(form);
	formData['uid'] = user.uid;
	//console.log(formData)
	$.ajax({
		method: 'POST',
		url: form.attr('action'),
		xhrFields: {
			withCredentials: true
		},
		data: formData,
		success: function(data) {
			if (data.status != 1) return message.text('提交失败：' + getErrorMsg(data.status));
			formData.host = user.uid;
			$.ajax({
				method: 'POST',
				url: 'http://121.43.228.141:8000/change/',
				xhrFields: {
					withCredentials: true
				},
				data: formData,
				success: function(data) {
					if (data.status != 1) return message.text('提交失败：' + getErrorMsg(data.status));
					message.textContent = '创建成功！';
					uid = user.uid;
					setTimeout(function(){
						page.removeClass('front-page').addClass('room-page');
						showRoom(user.uid);
					}, 1000);
				},
				error: function (e) {
					return message.addClass('show').text('HTTP Error ' + e.status + ': ' + e.statusText);
				},
				dataType: 'json'
			});
		},
		dataType: 'json'
	});
	return false;
});

$('.form-enter').on('submit', function (event) {
	event.preventDefault();
	var form = $('.form-enter');
	message.addClass('show').text('正在提交数据......');
	if (!checkForm(form)) return ((message.text('请完整填写表单')) && setTimeout(function(){
		message.text('').removeClass('show');
	}, 2000));
	var formData = fetchForm(form);
	$.ajax({
		method: 'POST',
		url: form.attr('action'),
		xhrFields: {
			withCredentials: true
		},
		data: formData,
		success: function(data) {
			if (data.status != 1) return message.text('提交失败：' + getErrorMsg(data.status));
			uid = formData.host;
			page.removeClass('front-page').addClass('room-page');
			showRoom(uid);
		},
		error: function (e) {
			return message.addClass('show').text('HTTP Error ' + e.status + ': ' + e.statusText);
		},
		dataType: 'json'
	});
	return false;
});

CodeboxInput.on('keypress', function (event) {
	// CodeboxInput.text(CodeboxInput.text()); // 去除 HTML 标签
	if (event.keyCode === 13) {
		var value = CodeboxInput.text().trim();
		outputLine.clone().addClass('user').text(value).appendTo(CodeboxOutput);
		CodeboxInput.text('');
		if (value != '') {
			//if (/^(move(North|South|East|West)|putBomb|endTurn)/.test(value)){
			//	if (/^(move(North|South|East|West)|putBomb|endTurn)\(\)$/.test(value)) {
					$.ajax({
						method: 'POST',
						url: 'http://121.43.228.141:8000/action/',
						xhrFields: {
							withCredentials: true
						},
						data: {
							move: value
						},
						success: function(data) {
							if (data.status != 1) return outputLine.clone().text('提交失败：' + getErrorMsg(data.status)).appendTo(CodeboxOutput);
							getLatestMsg();
							//outputLine.clone().text(data.info.content).appendTo(CodeboxOutput);
						},
						error: function (e) {
							return outputLine.clone().text('HTTP Error ' + e.status + ': ' + e.statusText).appendTo(CodeboxOutput);
						},
						dataType: 'json'
					});
			//	}
			//}
		}
		//CodeboxOutput.
	}
});/*.on('paste', function (event) {
	CodeboxInput.text(CodeboxInput.text()); 
});*/

$('.button-start').on('click', function (event) {
	if (uid == null) return;
	$.ajax({
		method: 'GET',
		url: 'http://121.43.228.141:8000/start/',
		xhrFields: {
			withCredentials: true
		},
		data: {
			host: uid
		},
		success: function(data) {
			if (data.status != 1) return outputLine.clone().text('提交失败：' + getErrorMsg(data.status)).appendTo(CodeboxOutput);
			outputLine.clone().text('您开始了游戏。').appendTo(CodeboxOutput);
			gameStart();
			getLatestMsg();
			$('.button-start').hide();
		},
		error: function (e) {
			return outputLine.clone().text('HTTP Error ' + e.status + ': ' + e.statusText).appendTo(CodeboxOutput);
		},
		dataType: 'json'
	});
});

$('.button-leave').on('click', function (event) {
	if (uid == null) return;
	confirm('您确定要离开房间么？') && $.ajax({
		method: 'POST',
		url: 'http://121.43.228.141:8000/leave/',
		xhrFields: {
			withCredentials: true
		},
		data: {
			host: uid
		},
		success: function(data) {
			if (data.status != 1) return outputLine.clone().text('提交失败：' + getErrorMsg(data.status)).appendTo(CodeboxOutput);
			uid = null;
			outputLine.clone().text('您已离开游戏！').appendTo(CodeboxOutput);
			page.removeClass('room-page').addClass('front-page');
		},
		error: function (e) {
			return outputLine.clone().text('HTTP Error ' + e.status + ': ' + e.statusText).appendTo(CodeboxOutput);
		},
		dataType: 'json'
	});
});
/*
// httponly, 此判断无效
if (document.cookie.indexOf('sessionid') > 0) {
	page.removeClass('access-page').addClass('front-page');
	$.ajax({
		method: 'POST',
		url: form.attr('action'),
		xhrFields: {
			withCredentials: true
		},
		success: function(data) {
			user = data.info;
		},
		dataType: 'json'
	});
}
*/

/*
var page = document.getElementsByClassName('page')[0];
var entry = document.getElementsByClassName('entry')[0];
var message = document.getElementsByClassName('message')[0];
var input = document.getElementsByClassName('codebox-output-line')[0];

entry.addEventListener('click', function (event) {
	var target = event.target;
	if (target.className.indexOf('button') < 0) return;
	if (page.dataset.action != target.dataset.type) {
		page.setAttribute('data-action', target.dataset.type);
		message.textContent = '';
		message.classList.remove('show');
	}
	else {
		if (target.dataset.type != 'return') {
			var form = document.getElementsByClassName('form-' + target.dataset.type)[0];
			message.classList.add('show');
			if ([].some.call(form.getElementsByTagName('input'), function(elem){
				return !elem.value.trim();
			})) return ((message.textContent = '请完整填写表单') && setTimeout(function(){
				message.textContent = '';
				message.classList.remove('show');
			}, 2000));
			var formData = new FormData(form);
			var xhr = new XMLHttpRequest();
			message.textContent = '正在提交数据......';
			entry.classList.add('hide');
			xhr.addEventListener('readystatechange', function(){
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						var data = JSON.parse(xhr.responseText);
						if (data.status == 1) {
							message.textContent = '创建成功！房间 ID：' + data.room_no;
							setTimeout(function(){
								page.classList.remove('front-page');
								page.classList.add('room-page');
								showRoom();
							}, 2000);
						}
					}
				}
			});
			xhr.open('POST', form.getAttribute('action'));
			xhr.send(form);
		}
	}
});

input.addEventListener('keypress', function (event) {
	if (event.keyCode === 13) {
		var value = input.textContent.trim();

	}
});*/
</script>
</body>
</html>